
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - Ma Boutique √âl√©gante</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="oda.jpg">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Menu Hamburger Overlay -->
    <div class="hamburger-overlay" id="hamburgerOverlay"></div>
    
    <!-- Menu Hamburger -->
    <div class="hamburger-menu" id="hamburgerMenu">
        <div class="hamburger-header">
            <div class="brand-section">
                <div class="logo-image"></div>
                <h1 class="brand-name">ODA</h1>
            </div>
            <button class="close-menu" id="closeMenu">
                <span>√ó</span>
            </button>
        </div>
        
        <nav class="hamburger-nav">
            <a href="#" class="hamburger-link active">
                <span class="link-icon">üìä</span>
                <span>Tableau de bord</span>
            </a>
            <a href="produit.html" class="hamburger-link">
                <span class="link-icon">üì¶</span>
                <span>Produits</span>
            </a>
            <a href="commandes.html" class="hamburger-link">
                <span class="link-icon">üìã</span>
                <span>Commandes</span>
            </a>
            <a href="clients.html" class="hamburger-link">
                <span class="link-icon">üë•</span>
                <span>Clients</span>
            </a>
            <a href="messages.html" class="hamburger-link">
                <span class="link-icon">üí¨</span>
                <span>Messages</span>
            </a>
            
            <div class="hamburger-divider"></div>
            
            <a href="statitique.html" class="hamburger-link">
                <span class="link-icon">üìä</span>
                <span>Statistiques</span>
            </a>
            <a href="parametres.html" class="hamburger-link">
                <span class="link-icon">‚öôÔ∏è</span>
                <span>Param√®tres</span>
            </a>
            <a href="e-commerce2.html" class="hamburger-link">
                <span class="link-icon">üè™</span>
                <span>Voir ma boutique</span>
            </a>
        </nav>
        
        <a href="https://whatsapp.com/channel/0029Vb6mcUm5q08htMMdVA2v" class="hamburger-link">
            <span class="link-icon">‚úÜ</span>
            <span>Rejoindre notre chaine</span>
        </a>
        <a href="https://t.me/+hqymnTrseaU2OWRk" class="hamburger-link">
            <span class="link-icon">üó©</span>
            <span>rejoindre notre groupe telegram</span>
        </a>
    </div>

    <header class="main-header">
        <div class="header-container">
            <button class="hamburger-btn" id="hamburgerBtn">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <div class="brand-section">
                <div class="logo-image"></div>
                <h1 class="brand-name">Ma Boutique √âl√©gante</h1>
            </div>

            <div class="header-actions">
                <button class="icon-btn notification-btn">
                    <span>üîî</span>
                    <span class="badge">3</span>
                </button>
                <div class="user-profile">
                    <div class="avatar-image"></div>
                    <span class="user-name">Admin</span>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar-left">
            <div class="action-section">
                <button class="btn-new-product">
                    <span>+</span>
                    <span>Nouveau produit</span>
                </button>
            </div>

            <section class="kpi-section">
                <h2 class="sidebar-title">Aujourd'hui</h2>
                <div class="kpi-card">
                    <div class="kpi-icon">üí∞</div>
                    <div class="kpi-content">
                        <p class="kpi-label">Chiffre d'affaires</p>
                        <p class="kpi-value">0 FCFA</p>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üì¶</div>
                    <div class="kpi-content">
                        <p class="kpi-label">Commandes</p>
                        <p class="kpi-value">0</p>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üë•</div>
                    <div class="kpi-content">
                        <p class="kpi-label">Visiteurs</p>
                        <p class="kpi-value">0</p>
                    </div>
                </div>
            </section>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">Ajouter un nouveau produit</h2>
                <p class="page-subtitle">Compl√©tez les informations ci-dessous pour cr√©er votre produit</p>
            </div>

            <form class="product-form" id="productForm">
                <section class="form-section">
                    <h3 class="section-title">üì∏ Image principale du produit</h3>
                    <p class="section-description">Ajoutez l'image principale qui repr√©sentera votre produit</p>
                    
                    <div class="image-upload-container">
                        <label for="productMainImage" class="upload-label">
                            <div class="upload-zone">
                                <div class="upload-icon">üì∏</div>
                                <p class="upload-text">Cliquez pour ajouter l'image principale</p>
                                <p class="upload-hint">PNG, JPG jusqu'√† 5MB</p>
                            </div>
                        </label>
                        <input type="file" id="productMainImage" accept="image/*" style="display: none;">
                        
                        <div id="mainImagePreview">
                            <div class="image-preview-wrapper">
                                <img id="mainImagePreviewImg">
                                <button type="button" id="removeMainImage" class="remove-image-btn">√ó</button>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="form-section">
                    <h3 class="section-title">üìù Informations de base</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Nom du produit <span class="required">*</span></label>
                        <input type="text" id="productName" class="form-input" placeholder="Ex: Robe √©l√©gante fleurie" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description <span class="required">*</span></label>
                        <textarea id="productDescription" class="form-textarea" placeholder="D√©crivez votre produit en d√©tail..." required></textarea>
                    </div>

                    <div class="description-images-section">
                        <h4 class="description-images-title">üñºÔ∏è Images de description (Maximum 3)</h4>
                        <p class="description-images-hint">Ajoutez jusqu'√† 3 images pour illustrer votre description produit</p>
                        
                        <div class="description-images-grid" id="descriptionImagesGrid">
                            <div class="description-image-slot" data-slot="1">
                                <div class="description-image-placeholder">
                                    <div class="description-image-icon">üñºÔ∏è</div>
                                    <p>Image 1</p>
                                </div>
                                <input type="file" accept="image/*" style="display: none;" class="desc-image-input">
                            </div>
                            
                            <div class="description-image-slot" data-slot="2">
                                <div class="description-image-placeholder">
                                    <div class="description-image-icon">üñºÔ∏è</div>
                                    <p>Image 2</p>
                                </div>
                                <input type="file" accept="image/*" style="display: none;" class="desc-image-input">
                            </div>
                            
                            <div class="description-image-slot" data-slot="3">
                                <div class="description-image-placeholder">
                                    <div class="description-image-icon">üñºÔ∏è</div>
                                    <p>Image 3</p>
                                </div>
                                <input type="file" accept="image/*" style="display: none;" class="desc-image-input">
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Prix (FCFA) <span class="required">*</span></label>
                            <input type="number" id="productPrice" class="form-input" placeholder="15000" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Stock <span class="required">*</span></label>
                            <input type="number" id="productStock" class="form-input" placeholder="50" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Cat√©gorie <span class="required">*</span></label>
                        <select id="productCategory" class="form-select" required>
                            <option value="">S√©lectionnez une cat√©gorie</option>
                            <option value="Vetements">Vetements</option>
                            <option value="Electroniques">Electroniques</option>
                            <option value="Decoration">Decoration</option>
                            <option value="Accessoires">Accessoires</option>
                            <option value="Electromenager">Electromenager</option>
                            <option value="Beaute & soin">Beaute & soin</option>
                            <option value="Accessoires">Accessoires</option>
                            <option value="Bebe">Bebe</option>
                            <option value="jeux & jouets">jeux & jouets</option>
                            <option value="Bricolage">Bricolage</option>
                            <option value="Alimentation">Alimentation</option>
                            <option value="Boissons">Boissons</option>
                            <option value="Livre">Livre</option>
                            <option value="Hygiene & sante">Hygiene & sante</option>
                            <option value="fitness">fitness</option>
                            <option value="Animaux">Animaux</option>
                            <option value="Luxe">Luxe</option>
                            <option value="Bureau">Bureau</option>
                        </select>
                    </div>
                </section>

                <section class="form-section">
                    <h3 class="section-title">üöÄ Statut de publication</h3>
                    
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="statusPublished" name="productStatus" value="published" checked>
                            <label for="statusPublished" class="radio-label">
                                <span class="radio-custom"></span>
                                <div>
                                    <strong>Publi√©</strong>
                                    <p>Le produit sera visible sur votre boutique</p>
                                </div>
                            </label>
                        </div>

                        <div class="radio-item">
                            <input type="radio" id="statusDraft" name="productStatus" value="draft">
                            <label for="statusDraft" class="radio-label">
                                <span class="radio-custom"></span>
                                <div>
                                    <strong>Brouillon</strong>
                                    <p>Le produit ne sera pas visible publiquement</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </section>

                <div class="form-actions">
                    <button type="button" class="btn-secondary">Aper√ßu</button>
                    <button type="submit" class="btn-primary">Enregistrer le produit</button>
                </div>
            </form>
        </main>

        <aside class="sidebar-right">
            <section class="preview-section">
                <h3 class="sidebar-title">üëÅÔ∏è Aper√ßu du produit</h3>
                
                <div class="product-preview-card">
                    <div class="preview-image-container">
                        <div class="preview-placeholder">
                            <p>üñºÔ∏è</p>
                            <p>Image principale</p>
                        </div>
                    </div>
                    
                    <div class="preview-content">
                        <h4 class="preview-title" id="previewTitle">Nom du produit</h4>
                        <p class="preview-description" id="previewDescription">La description appara√Ætra ici...</p>
                        
                        <div id="previewDescImages"></div>
                        
                        <p class="preview-price" id="previewPrice">0 FCFA</p>
                    </div>
                </div>
            </section>
        </aside>
    </div>

   <script type="module">
    // Configuration Supabase
    const SUPABASE_URL = 'https://xjckbqbqxcwzcrlmuvzf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqY2ticWJxeGN3emNybG11dnpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTk1MzMsImV4cCI6MjA3NjA5NTUzM30.AMzAUwtjFt7Rvof5r2enMyYIYToc1wNWWEjvZqK_YXM';

// Initialiser le client Supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Variables globales
let produits = [];
let descriptionImages = [null, null, null];
let mainImage = null;
let produitEnEdition = null;
let currentUser = null;

// ==================== INITIALISATION ====================

document.addEventListener('DOMContentLoaded', async () => {
    console.log('üå∏ Tableau de bord initialis√© !');
    
    // V√©rifier l'authentification en premier
    await verifierAuthentification();
    
    // Initialiser le menu hamburger
    initialiserMenuHamburger();
    
    // Ajouter le bouton de d√©connexion
    //ajouterBoutonDeconnexion();
    
    // V√©rifier la configuration
    await verifierConfiguration();
    
    // Initialiser les √©v√©nements
    initialiserEvenements();
    
    // Charger les donn√©es
    await chargerProduits();
    await chargerStatistiques();
    await verifierEditionDepuisLocalStorage();
});

// ==================== AUTHENTIFICATION ====================

async function verifierAuthentification() {
    try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) throw error;
        
        
        currentUser = session.user;
        console.log('‚úÖ Utilisateur connect√©:', currentUser.email);
        
        const userNameElement = document.querySelector('.user-name');
        if (userNameElement) {
            userNameElement.textContent = currentUser.email.split('@')[0];
        }
        
    } catch (error) {
        console.error('‚ùå Erreur authentification:', error);
        window.location.href = '#';
    }
}

function ajouterBoutonDeconnexion() {
    const userProfile = document.querySelector('.user-profile');
    if (!userProfile) return;
    
    const logoutBtn = document.createElement('button');
    logoutBtn.textContent = 'üö™ D√©connexion';
    logoutBtn.style.cssText = `
        margin-left: 15px;
        padding: 8px 16px;
        background: #FF3B30;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
        transition: all 0.3s ease;
    `;
    
    logoutBtn.addEventListener('mouseover', () => {
        logoutBtn.style.background = '#CC2F26';
    });
    
    logoutBtn.addEventListener('mouseout', () => {
        logoutBtn.style.background = '#FF3B30';
    });
    
    logoutBtn.addEventListener('click', async () => {
        try {
            const confirmer = confirm('Voulez-vous vraiment vous d√©connecter ?');
            if (!confirmer) return;
            
            logoutBtn.disabled = true;
            logoutBtn.textContent = '‚è≥ D√©connexion...';
            
            const { error } = await supabase.auth.signOut();
            
            if (error) throw error;
            
            console.log('‚úÖ D√©connexion r√©ussie');
            afficherNotification('‚úÖ D√©connexion r√©ussie', 'success');
            
            setTimeout(() => {
                window.location.href = 'connexion.html';
            }, 500);
            
        } catch (error) {
            console.error('‚ùå Erreur d√©connexion:', error);
            afficherNotification('‚ùå Erreur lors de la d√©connexion', 'error');
            logoutBtn.disabled = false;
            logoutBtn.textContent = 'üö™ D√©connexion';
        }
    });
    
    userProfile.appendChild(logoutBtn);
}

// ==================== MENU HAMBURGER ====================

function initialiserMenuHamburger() {
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const hamburgerMenu = document.getElementById('hamburgerMenu');
    const hamburgerOverlay = document.getElementById('hamburgerOverlay');
    const closeMenu = document.getElementById('closeMenu');
    
    if (hamburgerBtn) {
        hamburgerBtn.addEventListener('click', () => {
            hamburgerBtn.classList.toggle('active');
            hamburgerMenu?.classList.toggle('active');
            hamburgerOverlay?.classList.toggle('active');
            document.body.style.overflow = 'hidden';
        });
    }
    
    const fermerMenu = () => {
        hamburgerBtn?.classList.remove('active');
        hamburgerMenu?.classList.remove('active');
        hamburgerOverlay?.classList.remove('active');
        document.body.style.overflow = '';
    };
    
    if (closeMenu) {
        closeMenu.addEventListener('click', fermerMenu);
    }
    
    if (hamburgerOverlay) {
        hamburgerOverlay.addEventListener('click', fermerMenu);
    }
    
    const hamburgerLinks = document.querySelectorAll('.hamburger-link');
    hamburgerLinks.forEach(link => {
        link.addEventListener('click', () => {
            setTimeout(fermerMenu, 300);
        });
    });
    
    console.log('üçî Menu hamburger initialis√©');
}

// ==================== V√âRIFICATION CONFIGURATION ====================

async function verifierConfiguration() {
    try {
        console.log('üîç V√©rification de la configuration Supabase...');
        
        const { data, error } = await supabase
            .from('produits')
            .select('count')
            .limit(1);

        if (error) {
            console.error('‚ùå Erreur de connexion:', error);
            if (error.code === 'PGRST116') {
                afficherNotification('‚ö†Ô∏è La table "produits" n\'existe pas.', 'warning');
            } else if (error.message.includes('JWT')) {
                afficherNotification('‚ö†Ô∏è Erreur d\'authentification.', 'warning');
            }
        } else {
            console.log('‚úÖ Connexion Supabase r√©ussie !');
        }

        const { data: buckets, error: bucketError } = await supabase
            .storage
            .listBuckets();

        if (buckets) {
            const imagesBucket = buckets.find(b => b.name === 'images-produits');
            if (!imagesBucket) {
                console.warn('‚ö†Ô∏è Le bucket "images-produits" n\'existe pas');
                afficherNotification('‚ö†Ô∏è Cr√©ez le bucket "images-produits"', 'warning');
            } else {
                console.log('‚úÖ Bucket "images-produits" trouv√© !');
            }
        }

    } catch (error) {
        console.error('‚ùå Erreur lors de la v√©rification:', error);
    }
}

// ==================== INITIALISATION DES √âV√âNEMENTS ====================

function initialiserEvenements() {
    const form = document.getElementById('productForm');
    if (form) {
        form.addEventListener('submit', gererSoumissionFormulaire);
    }

    document.getElementById('productName')?.addEventListener('input', mettreAJourApercu);
    document.getElementById('productDescription')?.addEventListener('input', mettreAJourApercu);
    document.getElementById('productPrice')?.addEventListener('input', mettreAJourApercu);
    document.getElementById('productStock')?.addEventListener('input', mettreAJourApercu);

    const mainImageInput = document.getElementById('productMainImage');
    if (mainImageInput) {
        mainImageInput.addEventListener('change', gererImagePrincipale);
    }

    const removeMainImageBtn = document.getElementById('removeMainImage');
    if (removeMainImageBtn) {
        removeMainImageBtn.addEventListener('click', supprimerImagePrincipale);
    }

    const slots = document.querySelectorAll('.description-image-slot');
    slots.forEach((slot, index) => {
        const input = slot.querySelector('.desc-image-input');
        
        slot.addEventListener('click', (e) => {
            if (!e.target.closest('.description-image-remove')) {
                input.click();
            }
        });

        input.addEventListener('change', (e) => {
            gererImageDescription(e, index);
        });
    });

    console.log('üéØ √âv√©nements initialis√©s');
}

// ==================== GESTION DES IMAGES ====================

function gererImagePrincipale(e) {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
        afficherNotification('‚ùå Veuillez s√©lectionner une image', 'error');
        return;
    }

    if (file.size > 5 * 1024 * 1024) {
        afficherNotification('‚ùå L\'image ne doit pas d√©passer 5MB', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
        mainImage = event.target.result;
        afficherImagePrincipale(event.target.result);
        mettreAJourApercuPrincipal();
        afficherNotification('‚úÖ Image principale ajout√©e', 'success');
    };
    reader.readAsDataURL(file);
}

function afficherImagePrincipale(imageUrl) {
    const preview = document.getElementById('mainImagePreview');
    const previewImg = document.getElementById('mainImagePreviewImg');
    const uploadZone = document.querySelector('.upload-zone');

    if (preview && previewImg) {
        previewImg.src = imageUrl;
        preview.style.display = 'block';
        if (uploadZone) uploadZone.style.display = 'none';
    }
}

function supprimerImagePrincipale() {
    mainImage = null;
    
    const preview = document.getElementById('mainImagePreview');
    const uploadZone = document.querySelector('.upload-zone');
    const mainImageInput = document.getElementById('productMainImage');

    if (preview) preview.style.display = 'none';
    if (uploadZone) uploadZone.style.display = 'block';
    if (mainImageInput) mainImageInput.value = '';

    mettreAJourApercuPrincipal();
    afficherNotification('üóëÔ∏è Image principale supprim√©e', 'info');
}

function mettreAJourApercuPrincipal() {
    const previewContainer = document.querySelector('.preview-image-container');
    if (!previewContainer) return;

    if (mainImage) {
        previewContainer.innerHTML = `
            <img src="${mainImage}" style="width: 100%; height: 100%; object-fit: cover;" alt="Aper√ßu produit">
        `;
    } else {
        previewContainer.innerHTML = `
            <div style="color: var(--text-secondary); text-align: center;">
                <p style="font-size: 3rem;">üñºÔ∏è</p>
                <p>Image principale</p>
            </div>
        `;
    }
}

function gererImageDescription(e, slotIndex) {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
        afficherNotification('‚ùå Veuillez s√©lectionner une image', 'error');
        return;
    }

    if (file.size > 5 * 1024 * 1024) {
        afficherNotification('‚ùå L\'image ne doit pas d√©passer 5MB', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
        descriptionImages[slotIndex] = event.target.result;
        afficherImageDansSlot(slotIndex, event.target.result);
        mettreAJourApercuImages();
        afficherNotification(`‚úÖ Image ${slotIndex + 1} ajout√©e`, 'success');
    };
    reader.readAsDataURL(file);
}

function afficherImageDansSlot(slotIndex, imageUrl) {
    const slot = document.querySelector(`.description-image-slot[data-slot="${slotIndex + 1}"]`);
    if (!slot) return;

    slot.classList.add('has-image');
    slot.innerHTML = '';

    const img = document.createElement('img');
    img.src = imageUrl;
    img.className = 'description-image-preview';
    img.alt = `Image de description ${slotIndex + 1}`;
    slot.appendChild(img);

    const removeBtn = document.createElement('button');
    removeBtn.className = 'description-image-remove';
    removeBtn.innerHTML = '√ó';
    removeBtn.type = 'button';
    removeBtn.onclick = (e) => {
        e.stopPropagation();
        supprimerImageDescription(slotIndex);
    };
    slot.appendChild(removeBtn);

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.className = 'desc-image-input';
    input.style.display = 'none';
    input.addEventListener('change', (e) => gererImageDescription(e, slotIndex));
    slot.appendChild(input);
}

function supprimerImageDescription(slotIndex) {
    descriptionImages[slotIndex] = null;
    
    const slot = document.querySelector(`.description-image-slot[data-slot="${slotIndex + 1}"]`);
    if (!slot) return;

    slot.classList.remove('has-image');
    slot.innerHTML = `
        <div class="description-image-placeholder">
            <div class="description-image-icon">üñºÔ∏è</div>
            <p style="font-size: 0.85rem;">Image ${slotIndex + 1}</p>
        </div>
        <input type="file" accept="image/*" style="display: none;" class="desc-image-input">
    `;

    const input = slot.querySelector('.desc-image-input');
    input.addEventListener('change', (e) => gererImageDescription(e, slotIndex));

    mettreAJourApercuImages();
    afficherNotification(`üóëÔ∏è Image ${slotIndex + 1} supprim√©e`, 'info');
}

function mettreAJourApercuImages() {
    const container = document.getElementById('previewDescImages');
    if (!container) return;

    container.innerHTML = '';

    const imagesNonNulles = descriptionImages.filter(img => img !== null);
    
    if (imagesNonNulles.length === 0) return;

    imagesNonNulles.forEach((imageUrl, index) => {
        const imgWrapper = document.createElement('div');
        imgWrapper.style.cssText = `
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            box-shadow: 0 2px 8px rgba(199, 125, 255, 0.2);
        `;

        const img = document.createElement('img');
        img.src = imageUrl;
        img.style.cssText = `
            width: 100%;
            height: 100%;
            object-fit: cover;
        `;
        img.alt = `Description ${index + 1}`;

        imgWrapper.appendChild(img);
        container.appendChild(imgWrapper);
    });
}

function mettreAJourApercu() {
    const nom = document.getElementById('productName')?.value || 'Nom du produit';
    const description = document.getElementById('productDescription')?.value || 'La description appara√Ætra ici...';
    const prix = document.getElementById('productPrice')?.value || '0';

    const previewTitle = document.getElementById('previewTitle');
    const previewDescription = document.getElementById('previewDescription');
    const previewPrice = document.getElementById('previewPrice');

    if (previewTitle) previewTitle.textContent = nom;
    if (previewDescription) previewDescription.textContent = description;
    if (previewPrice) {
        const prixFormate = parseInt(prix) || 0;
        previewPrice.textContent = `${prixFormate.toLocaleString('fr-FR')} FCFA`;
    }
}
// ==================== FONCTIONS SUPABASE ====================

async function chargerProduits() {
    try {
        console.log('üì¶ Chargement des produits depuis Supabase...');
        
        if (!currentUser) {
            console.warn('‚ö†Ô∏è Aucun utilisateur connect√©');
            return [];
        }
        
        const { data, error } = await supabase
            .from('produits')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('‚ùå Erreur Supabase:', error);
            throw error;
        }

        produits = data || [];
        console.log(`‚úÖ ${produits.length} produit(s) charg√©(s) avec succ√®s`);
        
        return produits;
    } catch (error) {
        console.error('‚ùå Erreur compl√®te chargement produits:', error);
        
        if (error.message.includes('JWT')) {
            afficherNotification('‚ùå Erreur d\'authentification Supabase.', 'error');
        } else if (error.message.includes('Failed to fetch')) {
            afficherNotification('‚ùå Impossible de se connecter √† Supabase.', 'error');
        } else if (error.code === 'PGRST116' || error.message.includes('relation')) {
            afficherNotification('‚ùå La table "produits" n\'existe pas.', 'error');
        } else {
            afficherNotification(`‚ùå Erreur: ${error.message}`, 'error');
        }
        
        return [];
    }
}

async function sauvegarderProduit(produitData) {
    try {
        console.log('üíæ Tentative de sauvegarde:', produitData);
        
        produitData.user_id = currentUser.id;
        
        const { data, error } = await supabase
            .from('produits')
            .insert([produitData])
            .select()
            .single();

        if (error) {
            console.error('‚ùå Erreur d√©taill√©e Supabase:', error);
            throw error;
        }

        console.log('üíæ Produit sauvegard√© avec succ√®s:', data);
        return data;
    } catch (error) {
        console.error('‚ùå Erreur sauvegarde produit:', error);
        throw error;
    }
}

async function mettreAJourProduit(id, produitData) {
    try {
        console.log('‚úèÔ∏è Mise √† jour du produit:', id, produitData);
        
        const { data, error } = await supabase
            .from('produits')
            .update(produitData)
            .eq('id', id)
            .eq('user_id', currentUser.id)
            .select()
            .single();

        if (error) {
            console.error('‚ùå Erreur mise √† jour:', error);
            throw error;
        }

        console.log('‚úèÔ∏è Produit mis √† jour:', data);
        return data;
    } catch (error) {
        console.error('‚ùå Erreur mise √† jour produit:', error);
        throw error;
    }
}

async function supprimerProduit(id) {
    try {
        const { error } = await supabase
            .from('produits')
            .delete()
            .eq('id', id)
            .eq('user_id', currentUser.id);

        if (error) throw error;

        console.log('üóëÔ∏è Produit supprim√©');
        await chargerProduits();
        afficherNotification('‚úÖ Produit supprim√© avec succ√®s', 'success');
    } catch (error) {
        console.error('‚ùå Erreur suppression produit:', error);
        afficherNotification('‚ùå Erreur lors de la suppression', 'error');
    }
}

// ==================== UPLOAD D'IMAGES ====================

async function uploaderImageVersSupabase(imageBase64, nomFichier) {
    try {
        console.log('üì§ D√©but upload image:', nomFichier);
        
        const response = await fetch(imageBase64);
        const blob = await response.blob();
        
        const timestamp = Date.now();
        const randomStr = Math.random().toString(36).substring(7);
        const extension = blob.type.split('/')[1];
        
        const cheminFichier = `${currentUser.id}/produits/${timestamp}_${randomStr}_${nomFichier}.${extension}`;

        console.log('üì§ Upload vers:', cheminFichier);

        const { data, error } = await supabase.storage
            .from('images-produits')
            .upload(cheminFichier, blob, {
                contentType: blob.type,
                upsert: false
            });

        if (error) {
            console.error('‚ùå Erreur upload storage:', error);
            
            if (error.message.includes('Bucket not found')) {
                throw new Error('Le bucket "images-produits" n\'existe pas.');
            } else if (error.message.includes('policy')) {
                throw new Error('Erreur de permission. V√©rifiez les politiques RLS.');
            }
            throw error;
        }

        console.log('‚úÖ Upload r√©ussi:', data);

        const { data: urlData } = supabase.storage
            .from('images-produits')
            .getPublicUrl(cheminFichier);

        console.log('üîó URL publique:', urlData.publicUrl);
        return urlData.publicUrl;
    } catch (error) {
        console.error('‚ùå Erreur upload image:', error);
        throw error;
    }
}

// ==================== GESTION DU FORMULAIRE ====================

async function gererSoumissionFormulaire(e) {
    e.preventDefault();

    const nom = document.getElementById('productName').value.trim();
    const description = document.getElementById('productDescription').value.trim();
    const prix = parseFloat(document.getElementById('productPrice').value);
    const stock = parseInt(document.getElementById('productStock').value);
    const categorie = document.getElementById('productCategory').value;
    const statut = document.querySelector('input[name="productStatus"]:checked').value;

    if (!nom || !description || !categorie) {
        afficherNotification('‚ùå Veuillez remplir tous les champs obligatoires', 'error');
        return;
    }

    if (isNaN(prix) || prix <= 0) {
        afficherNotification('‚ùå Le prix doit √™tre un nombre positif', 'error');
        return;
    }

    if (isNaN(stock) || stock < 0) {
        afficherNotification('‚ùå Le stock doit √™tre un nombre positif ou z√©ro', 'error');
        return;
    }

    if (!mainImage) {
        afficherNotification('‚ùå Veuillez ajouter une image principale', 'error');
        return;
    }

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const texteBoutonOriginal = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ Enregistrement...';

    try {
        let mainImageUrl;
        
        if (mainImage.startsWith('http')) {
            mainImageUrl = mainImage;
            console.log('‚úÖ Utilisation de l\'image existante:', mainImageUrl);
        } else {
            afficherNotification('üì§ Upload de l\'image principale...', 'info');
            mainImageUrl = await uploaderImageVersSupabase(mainImage, 'main');
            
            if (!mainImageUrl) {
                throw new Error('√âchec de l\'upload de l\'image principale');
            }
        }

        const descriptionImagesUrls = [];
        for (let i = 0; i < descriptionImages.length; i++) {
            if (descriptionImages[i]) {
                if (descriptionImages[i].startsWith('http')) {
                    descriptionImagesUrls.push(descriptionImages[i]);
                    console.log(`‚úÖ Image ${i + 1} existante conserv√©e`);
                } else {
                    afficherNotification(`üì§ Upload de l'image ${i + 1}...`, 'info');
                    const url = await uploaderImageVersSupabase(descriptionImages[i], `desc_${i}`);
                    if (url) {
                        descriptionImagesUrls.push(url);
                    }
                }
            }
        }

        const produitData = {
            nom: nom,
            description: description,
            prix: prix,
            stock: stock,
            categorie: categorie,
            statut: statut,
            main_image: mainImageUrl,
            description_images: descriptionImagesUrls.length > 0 ? descriptionImagesUrls : null
        };

        console.log('üíæ Donn√©es √† sauvegarder:', produitData);

        if (produitEnEdition) {
            await mettreAJourProduit(produitEnEdition.id, produitData);
            afficherNotification('‚ú® Produit mis √† jour avec succ√®s !', 'success');
            produitEnEdition = null;
        } else {
            await sauvegarderProduit(produitData);
            afficherNotification('‚ú® Produit ajout√© avec succ√®s !', 'success');
        }

        await chargerProduits();
        await chargerStatistiques();
        reinitialiserFormulaire();
        
    } catch (error) {
        console.error('‚ùå Erreur compl√®te:', error);
        
        let messageErreur = 'Erreur lors de l\'enregistrement du produit';
        
        if (error.message.includes('storage') || error.message.includes('Bucket')) {
            messageErreur = 'Erreur lors de l\'upload des images.';
        } else if (error.message.includes('permission') || error.message.includes('RLS')) {
            messageErreur = 'Erreur de permission. V√©rifiez vos politiques RLS.';
        } else if (error.message.includes('JWT')) {
            messageErreur = 'Erreur d\'authentification.';
        } else if (error.message) {
            messageErreur = error.message;
        }
        
        afficherNotification(`‚ùå ${messageErreur}`, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = texteBoutonOriginal;
    }
}

function reinitialiserFormulaire() {
    document.getElementById('productForm').reset();
    descriptionImages = [null, null, null];
    mainImage = null;
    produitEnEdition = null;

    const preview = document.getElementById('mainImagePreview');
    const uploadZone = document.querySelector('.upload-zone');
    if (preview) preview.style.display = 'none';
    if (uploadZone) uploadZone.style.display = 'block';

    const slots = document.querySelectorAll('.description-image-slot');
    slots.forEach((slot, index) => {
        slot.classList.remove('has-image');
        slot.innerHTML = `
            <div class="description-image-placeholder">
                <div class="description-image-icon">üñºÔ∏è</div>
                <p style="font-size: 0.85rem;">Image ${index + 1}</p>
            </div>
            <input type="file" accept="image/*" style="display: none;" class="desc-image-input">
        `;
        const input = slot.querySelector('.desc-image-input');
        input.addEventListener('change', (e) => gererImageDescription(e, index));
    });

    mettreAJourApercu();
    mettreAJourApercuImages();
    mettreAJourApercuPrincipal();
    
    console.log('‚ú® Formulaire r√©initialis√©');
}

// ==================== √âDITION DE PRODUIT ====================

async function verifierEditionDepuisLocalStorage() {
    const idProduit = localStorage.getItem('produit_en_edition');
    
    if (idProduit) {
        console.log('üìù Chargement du produit pour √©dition:', idProduit);
        await chargerProduitPourEdition(parseInt(idProduit));
        localStorage.removeItem('produit_en_edition');
    }
}

async function chargerProduitPourEdition(id) {
    try {
        const { data, error } = await supabase
            .from('produits')
            .select('*')
            .eq('id', id)
            .eq('user_id', currentUser.id)
            .single();

        if (error) throw error;

        produitEnEdition = data;

        document.getElementById('productName').value = data.nom;
        document.getElementById('productDescription').value = data.description;
        document.getElementById('productPrice').value = data.prix;
        document.getElementById('productStock').value = data.stock;
        document.getElementById('productCategory').value = data.categorie;
        document.querySelector(`input[name="productStatus"][value="${data.statut}"]`).checked = true;

        if (data.main_image) {
            mainImage = data.main_image;
            afficherImagePrincipale(data.main_image);
        }

        if (data.description_images && Array.isArray(data.description_images)) {
            data.description_images.forEach((url, index) => {
                if (index < 3) {
                    descriptionImages[index] = url;
                    afficherImageDansSlot(index, url);
                }
            });
        }

        mettreAJourApercu();
        mettreAJourApercuImages();
        afficherNotification('‚úèÔ∏è Produit charg√© pour √©dition', 'info');

        const form = document.getElementById('productForm');
        if (form) {
            form.scrollIntoView({ behavior: 'smooth' });
        }
    } catch (error) {
        console.error('‚ùå Erreur chargement produit:', error);
        afficherNotification('‚ùå Erreur lors du chargement du produit', 'error');
    }
}

// ==================== STATISTIQUES ====================

async function chargerStatistiques() {
    try {
        if (!currentUser) return;
        
        const { data: produits, error: produitsError } = await supabase
            .from('produits')
            .select('*')
            .eq('user_id', currentUser.id);
        
        if (produitsError) throw produitsError;
        
        const { data: commandes, error: commandesError } = await supabase
            .from('commandes')
            .select('*')
            .eq('user_id', currentUser.id);
        
        const nbProduits = produits?.length || 0;
        const nbCommandes = commandes?.length || 0;
        
        let chiffreAffaires = 0;
        if (commandes && commandes.length > 0) {
            chiffreAffaires = commandes.reduce((total, cmd) => total + (cmd.montant || 0), 0);
        }
        
        const kpiCards = document.querySelectorAll('.kpi-card');
        if (kpiCards[0]) {
            const valueElem = kpiCards[0].querySelector('.kpi-value');
            if (valueElem) {
                valueElem.textContent = `${chiffreAffaires.toLocaleString('fr-FR')} FCFA`;
            }
        }
        
        if (kpiCards[1]) {
            const valueElem = kpiCards[1].querySelector('.kpi-value');
            if (valueElem) {
                valueElem.textContent = nbCommandes;
            }
        }
        
        if (kpiCards[2]) {
            const valueElem = kpiCards[2].querySelector('.kpi-value');
            if (valueElem) {
                valueElem.textContent = nbProduits;
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erreur chargement statistiques:', error);
    }
}

// ==================== NOTIFICATIONS ====================

function afficherNotification(message, type = 'info') {
    let conteneur = document.getElementById('notification-container');

    if (!conteneur) {
        conteneur = document.createElement('div');
        conteneur.id = 'notification-container';
        conteneur.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        `;
        document.body.appendChild(conteneur);
    }

    const couleurs = {
        success: '#34C759',
        error: '#FF3B30',
        info: '#007AFF',
        warning: '#FF9500'
    };

    const notification = document.createElement('div');
    notification.style.cssText = `
        background: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-left: 4px solid ${couleurs[type]};
        animation: slideIn 0.5s ease;
        max-width: 350px;
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
        color: #333;
    `;
    notification.textContent = message;

    conteneur.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.5s ease';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

// ==================== ANIMATIONS CSS ====================

const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes fadeOut {
        to {
            opacity: 0;
            transform: translateY(-10px);
        }
    }
`;
document.head.appendChild(style);

// ==================== LOG ====================

console.log('%cüå∏ Tableau de Bord E-commerce avec Supabase üå∏', 'color: #007AFF; font-size: 20px; font-weight: bold;');
console.log('%c‚úÖ Boutique personnalis√©e par utilisateur', 'color: #34C759; font-size: 14px;');
console.log('%c‚ú® Fonctionnalit√©s : Upload d\'images + Stockage cloud ‚ú®', 'color: #007AFF; font-size: 14px; font-weight: bold;');
   </script>
</html>